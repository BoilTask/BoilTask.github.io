<!doctype html><html lang=zh-CN dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content="简介 本文主要用于整理虚幻引擎中移动相关的机制。\n内容可能摘录自各个文章、论坛、文档等，仅用作记录。\n基础简介 移动是一个非常重要并且较为复杂的模块，UnrealEngine对于移动的实现使用了组合模式，在描述Actor的移动时，含义是具有移动组件的Actor可以移动。\n"><title>虚幻引擎中角色移动相关机制 - BoilTask's Blog</title>
<link rel=canonical href=https://boiltask.com/knowledge/ue/character-movement/><link rel=stylesheet href=/scss/style.min.42356e3d96358a73961d9676317b34bb798dbae279b8a8014a89192825a462b2.css><meta property='og:title' content="虚幻引擎中角色移动相关机制 - BoilTask's Blog"><meta property='og:description' content="简介 本文主要用于整理虚幻引擎中移动相关的机制。\n内容可能摘录自各个文章、论坛、文档等，仅用作记录。\n基础简介 移动是一个非常重要并且较为复杂的模块，UnrealEngine对于移动的实现使用了组合模式，在描述Actor的移动时，含义是具有移动组件的Actor可以移动。\n"><meta property='og:url' content='https://boiltask.com/knowledge/ue/character-movement/'><meta property='og:site_name' content="BoilTask's Blog"><meta property='og:type' content='article'><meta property='article:section' content='Post'><meta property='article:tag' content='cpp'><meta property='article:tag' content='unrealengine'><meta property='article:published_time' content='2025-04-02T12:54:31+08:00'><meta property='article:modified_time' content='2025-04-02T12:54:31+08:00'><meta name=twitter:title content="虚幻引擎中角色移动相关机制 - BoilTask's Blog"><meta name=twitter:description content="简介 本文主要用于整理虚幻引擎中移动相关的机制。\n内容可能摘录自各个文章、论坛、文档等，仅用作记录。\n基础简介 移动是一个非常重要并且较为复杂的模块，UnrealEngine对于移动的实现使用了组合模式，在描述Actor的移动时，含义是具有移动组件的Actor可以移动。\n"><link rel="shortcut icon" href=/favicon.ico><script async src="https://www.googletagmanager.com/gtag/js?id=G-RMFB7F2J15"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-RMFB7F2J15")}</script><style>.main-container{display:none}</style><script>let isShouldLoad=!0;setTimeout(()=>{if(isShouldLoad){const e=document.getElementById("loadingOverlay");e&&(e.style.display="flex")}},200)</script><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-9893770372946812" crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/pangu/dist/browser/pangu.min.js></script><script>document.addEventListener("DOMContentLoaded",()=>{isShouldLoad=!1,pangu.spacingPage();const e=document.getElementsByClassName("main-container");for(let t=0;t<e.length;t++)e[t].style.display="flex";const t=document.getElementById("loadingOverlay");t&&(t.style.display="none")})</script></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label=切换菜单>
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/images/avatar_hu_de3d07ee7a4399c6.jpg width=300 height=300 class=site-logo loading=lazy alt=Avatar></a></figure><div class=site-meta><h1 class=site-name><a href=/>BoilTask's Blog</a></h1><h2 class=site-description>Game developer and designer, C/C++ | Golang | UE | Web</h2></div></header><ol class=menu-social><li><a href=https://github.com/BoilTask target=_blank title=GitHub rel=me><svg class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><svg class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>主页</span></a></li><li><a href=/archives/><svg class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>文章归档</span></a></li><li><a href=/categories/><svg class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg>
<span>分类</span></a></li><li><a href=/tags/><svg class="icon icon-tabler icon-tabler-tag" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11 3l9 9a1.5 1.5.0 010 2l-6 6a1.5 1.5.0 01-2 0L3 11V7a4 4 0 014-4h4"/><circle cx="9" cy="9" r="2"/></svg>
<span>标签云</span></a></li><li><a href=/links/><svg class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg>
<span>友情链接</span></a></li><li><a href=/search/><svg class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>搜索</span></a></li><li class=menu-bottom-section><ol class=menu><li id=dark-mode-toggle><svg class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>暗色模式</span></li></ol></li></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">目录</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#简介>简介</a></li><li><a href=#基础简介>基础简介</a></li><li><a href=#移动流程>移动流程</a><ol><li><a href=#自主实现>自主实现</a></li><li><a href=#引擎实现>引擎实现</a></li><li><a href=#玩家输入>玩家输入</a></li><li><a href=#主控角色移动>主控角色移动</a></li><li><a href=#协议选择>协议选择</a></li></ol></li><li><a href=#server同步移动给客户端>Server同步移动给客户端</a><ol><li><a href=#actor基本同步方案>Actor基本同步方案</a></li><li><a href=#character移动同步>Character移动同步</a></li></ol></li><li><a href=#关键概念>关键概念</a><ol><li><a href=#ucharactermovement>UCharacterMovement</a></li><li><a href=#fsavedmove_character>FSavedMove_Character</a></li><li><a href=#replicatemovetoserver>ReplicateMoveToServer</a></li><li><a href=#延迟发送move>延迟发送Move</a></li><li><a href=#callservermove>CallServerMove</a></li><li><a href=#servermoveold>ServerMoveOld</a></li></ol></li><li><a href=#todo>TODO</a></li><li><a href=#参考文章>参考文章</a></li></ol></nav></div></section></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><header class=article-category><a href=/categories/knowledge/>知识汇总</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/knowledge/ue/character-movement/>虚幻引擎中角色移动相关机制</a></h2></div><footer class=article-time><div class=article-time-item><svg class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg>
文章字数：3713</div><div class=article-time-item><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>阅读时长: 8 分钟</time></div><div class=article-time-item><svg class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>2025-04-02 12:54:31</time></div></footer></div></header><section class=article-content><h2 id=简介><a href=#%e7%ae%80%e4%bb%8b class=header-anchor></a>简介</h2><p>本文主要用于整理虚幻引擎中移动相关的机制。</p><p>内容可能摘录自各个文章、论坛、文档等，仅用作记录。</p><h2 id=基础简介><a href=#%e5%9f%ba%e7%a1%80%e7%ae%80%e4%bb%8b class=header-anchor></a>基础简介</h2><p>移动是一个非常重要并且较为复杂的模块，<code>UnrealEngine</code>对于移动的实现使用了组合模式，在描述<code>Actor</code>的移动时，含义是具有移动组件的<code>Actor</code>可以移动。</p><p>移动组件的基类为<code>UMovementComponent</code>，提供基本的移动功能，有多个不同功能的子类，一些子类移动组件专门用于服务一种特殊的<code>Actor</code>，比如通常代表玩家的<code>ACharacter</code>，对应的移动组件<code>UCharacterMovementComponent</code>。</p><p><code>Actor</code>虽然代表在<code>World</code>中的一个实体，但是本身是没有位置概念的。<code>Actor</code>的位置由其具有的<code>USceneComponent</code>赋予。因此移动的本质，就是改变<code>Actor</code>上的某个<code>USceneComponent</code>的位置，通常指的是<code>Actor</code>的<code>RootComponent</code>。</p><p><code>UMovementComponent</code>上有个属性<code>UpdatedComponent</code>，就是用于设置移动组件所修改的<code>USceneComponent</code>。暴露给蓝图有个参数<code>bAutoRegisterUpdatedComponent</code>，如果设置为<code>true</code>，则会在组件初始化时，读取<code>Owner</code>的<code>RootComponent</code>，调用<code>SetUpdatedComponent</code>设置<code>UpdatedComponent</code>。</p><h2 id=移动流程><a href=#%e7%a7%bb%e5%8a%a8%e6%b5%81%e7%a8%8b class=header-anchor></a>移动流程</h2><p>网络同步下的角色移动至少需要考虑以下几个方面：</p><ul><li>玩家客户端操作无延迟<ul><li>需要直接响应移动输入并上报给服务器</li></ul></li><li>位置以服务器为准<ul><li>防止外挂</li></ul></li><li>同步到的移动需要表现丝滑<ul><li>不可能每帧都收到位置更新，需要适当进行插值</li></ul></li></ul><h3 id=自主实现><a href=#%e8%87%aa%e4%b8%bb%e5%ae%9e%e7%8e%b0 class=header-anchor></a>自主实现</h3><p>先思考如果自己实现的情况下可能会怎么做。</p><ul><li>本地接收到输入之后，在本地先操作移动，同时把移动的操作发送给服务器<ul><li>可能包含的信息是：当前位置、目标位置等</li></ul></li><li>服务器接收到移动的操作，在服务器上执行移动，并把玩家位移的信息同步给所有客户端<ul><li>信息同样包含：当前位置、目标位置、速度等</li></ul></li><li>其他客户端收到了移动的信息后，修改角色的移动目标，根据插值调整角色位置</li></ul><h3 id=引擎实现><a href=#%e5%bc%95%e6%93%8e%e5%ae%9e%e7%8e%b0 class=header-anchor></a>引擎实现</h3><p>虚幻引擎网络同步情况下的移动流程与此类似，大概为：</p><ul><li><p>每一帧执行TickComponent时，计算这一帧的加速度和转向，之后对于主控的Character，调用ReplicateMoveToServer把移动同步给服务器</p></li><li><p>ReplicateMoveToServer会把移动保存到列表，然后执行PerformMovement在本地预执行移动操作。</p></li><li><p>然后会调用ServerMove把移动同步给服务器，告知移动的参数、客户端自己移动的位置，以及时间戳</p></li><li><p>ServerMove在服务器上执行，根据客户端声明的位置，与服务器的位置做对比，如果差异过大，则调用ClientAdjustPosition在主控端校正位置</p></li><li><p>客户端如果收到ClientAdjustPosition，会把客户端角色位置设置为服务器上的位置，并把bUpdatePosition标记为true，这将会影响到后续的移动更新</p></li><li><p>当客户端再次调用TickComponent时，如果存在bUpdatePosition，则会调用ClientUpdatePositionAfterServerUpdate来重演在服务器上调整移动之后发生的所有移动。</p><blockquote><p>在引擎源码CharacterMovementComponent.h中可以找到对移动同步流程的描述：</p><p>Here&rsquo;s how player movement prediction, replication and correction works in network games:</p><p>Every tick, the TickComponent() function is called. It figures out the acceleration and rotation change for the frame,
and then calls PerformMovement() (for locally controlled Characters), or ReplicateMoveToServer() (if it&rsquo;s a network client).</p><p>ReplicateMoveToServer() saves the move (in the PendingMove list), calls PerformMovement(), and then replicates the move
to the server by calling the replicated function ServerMove() - passing the movement parameters, the client&rsquo;s
resultant position, and a timestamp.</p><p>ServerMove() is executed on the server. It decodes the movement parameters and causes the appropriate movement
to occur. It then looks at the resulting position and if enough time has passed since the last response, or the
position error is significant enough, the server calls ClientAdjustPosition(), a replicated function.</p><p>ClientAdjustPosition() is executed on the client. The client sets its position to the servers version of position,
and sets the bUpdatePosition flag to true.</p><p>When TickComponent() is called on the client again, if bUpdatePosition is true, the client will call
ClientUpdatePosition() before calling PerformMovement(). ClientUpdatePosition() replays all the moves in the pending
move list which occurred after the timestamp of the move the server was adjusting.</p></blockquote></li></ul><h3 id=玩家输入><a href=#%e7%8e%a9%e5%ae%b6%e8%be%93%e5%85%a5 class=header-anchor></a>玩家输入</h3><p>管理玩家输入的也是一个组件<code>UInputComponent</code>，通常可以调用<code>BindAxis</code>来注册事件响应。</p><p>一般最终会调用到<code>UPawnMovementComponent::AddInputVector</code>来处理移动。</p><h3 id=主控角色移动><a href=#%e4%b8%bb%e6%8e%a7%e8%a7%92%e8%89%b2%e7%a7%bb%e5%8a%a8 class=header-anchor></a>主控角色移动</h3><p>在UE的网络框架中，角色主要分为三种：ROLE_Authority、ROLE_AutonomousProxy、ROLE_SimulatedProxy。</p><blockquote><p>详见：<a class=link href=/ue/network-role/>虚幻引擎中网络角色Role相关概念</a></p></blockquote><p>在客户端主控角色也即Autonomous角色会接受控制，然后把移动数据发往服务器。</p><p>本地的每次移动都会生成FSavedMove_Character，并维护一个<code>TArray&lt;FSavedMovePtr> SavedMoves</code>的数组，保存了当前玩家本地已经做的移动，这些移动还没经过服务器检查。</p><p>如果服务器认可了一些移动，就可以把这些移动删掉，如果检查不通过，就可以据此执行异常处理。</p><h3 id=协议选择><a href=#%e5%8d%8f%e8%ae%ae%e9%80%89%e6%8b%a9 class=header-anchor></a>协议选择</h3><p>在UE中，默认使用UDP作为传输协议，这可以使得数据包尽快送达。</p><p>UDP不保证可达和有序，但是应用层面可以通过设计来在需要的地方避免这些问题。</p><h2 id=server同步移动给客户端><a href=#server%e5%90%8c%e6%ad%a5%e7%a7%bb%e5%8a%a8%e7%bb%99%e5%ae%a2%e6%88%b7%e7%ab%af class=header-anchor></a>Server同步移动给客户端</h2><h3 id=actor基本同步方案><a href=#actor%e5%9f%ba%e6%9c%ac%e5%90%8c%e6%ad%a5%e6%96%b9%e6%a1%88 class=header-anchor></a>Actor基本同步方案</h3><p>Actor自身就支持移动同步，打开ReplicateMovement开关后，当Actor的RootComponent位置、朝向等数据发生变化时，就会把数据同步给Simulate客户端。</p><p>当Simulate的客户端收到同步之后，会简单的设置自己的位置和朝向。移动数据的同步有间隔，因此这种实现会导致Actor发生闪现。</p><h3 id=character移动同步><a href=#character%e7%a7%bb%e5%8a%a8%e5%90%8c%e6%ad%a5 class=header-anchor></a>Character移动同步</h3><p>针对Actor基本同步模式的不足，CharacterMovementComponent针对性的做了表现平滑处理，让Simulate角色移动尽可能平滑自然。</p><p>Character主要有两个组件，Capsule和Mesh，Capsule是Chara</p><h2 id=关键概念><a href=#%e5%85%b3%e9%94%ae%e6%a6%82%e5%bf%b5 class=header-anchor></a>关键概念</h2><h3 id=ucharactermovement><a href=#ucharactermovement class=header-anchor></a>UCharacterMovement</h3><p>角色移动组件是最为复杂的一个子类，需要重点进行分析。</p><pre class=mermaid>
  classDiagram
    class UCharacterMovementComponent {
        +IRVOAvoidanceInterface
        +INetworkPredictionInterface
    }
    UActorComponent &lt;|-- UMovementComponent
    UMovementComponent &lt;|-- UNavMovementComponent
    UNavMovementComponent &lt;|-- UPawnMovementComponent
    UPawnMovementComponent &lt;|-- UCharacterMovementComponent
</pre><h3 id=fsavedmove_character><a href=#fsavedmove_character class=header-anchor></a>FSavedMove_Character</h3><p>用于描述玩家的一次移动，可以认为是一次移动的快照。</p><p>主要属性有：</p><div class=table-wrapper><table><thead><tr><th>属性</th><th>描述</th></tr></thead><tbody><tr><td>TimeStamp</td><td>这次移动发生的时间</td></tr><tr><td>DeltaTime</td><td>这次移动使用的时间</td></tr><tr><td>CustomTimeDilation</td><td>时间膨胀系数，可以用于快进和慢放</td></tr><tr><td>StartPackedMovementMode</td><td>移动发生前的MovementMode</td></tr><tr><td>StartLocation</td><td>移动发生前的位置</td></tr><tr><td>StartVelocity</td><td>移动发生前的速度</td></tr><tr><td>EndPackedMovementMode</td><td>移动发生后的MovementMode</td></tr><tr><td>SavedLocation</td><td>移动发生后的位置</td></tr><tr><td>SavedVelocity</td><td>移动发生后的速度</td></tr><tr><td>Acceleration</td><td>移动所用加速度</td></tr></tbody></table></div><p>理论上只要有这些数据，就能复盘整个移动过程，也可用作回放功能。</p><h3 id=replicatemovetoserver><a href=#replicatemovetoserver class=header-anchor></a>ReplicateMoveToServer</h3><p>首先会从SavedMoves里找到最早发生的一个ImportantMove（通过IsImportantMove判断），也就是最新被服务器确认的有显著差异的Move。</p><p>之后创建一个FSavedMove_Character并初始化。然后执行PerformMovement，对角色计算操作后的属性，设置上相关信息。</p><p>根据能否被合并，进行处理。</p><h3 id=延迟发送move><a href=#%e5%bb%b6%e8%bf%9f%e5%8f%91%e9%80%81move class=header-anchor></a>延迟发送Move</h3><p>一个Move有可能可以被延迟一会，与后面的Move合并后再发给服务器。因此一个新建的Move被发往服务器前会先判断是否可以延迟发送。</p><p>首先判断是否开启了NetEnableMoveCombining，如果没开也不会延迟发送。</p><p>同时还会判断当前的Move是否能被延迟发送，会检查该Move前后MovementMode是否改变，如果改变也需要即使变化。也就是说，如果此次Move没有显著改变，那么则可以延后发送，理论上服务器根据之前的信息推算，结果应该是一样的。</p><p>然后会计算当前预期的移动更新时间间隔，根据当前网速、玩家数量等信息，在基准值ClientNetSendMoveDeltaTime上做调整，得到最终间隔，如果Tick时还没达到更新间隔，就会延迟发送Move，把它储存在PendingMove中，留着以后处理。</p><h3 id=callservermove><a href=#callservermove class=header-anchor></a>CallServerMove</h3><p>函数接受两个参数，一个是刚创建的Move，另一个是之前获取的ImportantMove（ImportantMove可能为空）。不需要把整个Move都发往服务器，只需要位置、旋转、加速度等关键信息，并且这些信息会经过压缩。</p><p>压缩的过程简单来说，会尝试牺牲精度，把一些字段合并在一个数据结构中。</p><p>之后还会调用ServerMoveOld，把ImportantMove中的一些信息发送到服务器，可以简单理解为一种冗余的保险。</p><p>如果存在PendingMove，说明存在未合并的Move，需要调用ServerMoveDual一次发送两个连续的Move。否则，说明发送间隔较大，或者PendingMove已经被合并，就调用ServerMode发送这个Move。</p><h3 id=servermoveold><a href=#servermoveold class=header-anchor></a>ServerMoveOld</h3><p>ServerMoveOld主要作为一种冗余措施，防止服务器新收到一个移动数据时，因为网络丢包而落后太多，导致移动判断不通过，进而纠正客户端位置。ServerMoveOld可以让服务器使用传递的加速度，粗略的从旧位置快速移动到新位置，不校验移动结果。</p><blockquote><p>TODO：安全性如何保证？</p></blockquote><h2 id=todo><a href=#todo class=header-anchor></a>TODO</h2><ul><li><p>具有物理模拟下的移动</p></li><li><p>移动如何通过RPC发送的</p></li></ul><h2 id=参考文章><a href=#%e5%8f%82%e8%80%83%e6%96%87%e7%ab%a0 class=header-anchor></a>参考文章</h2><ul><li><a class=link href=https://zhuanlan.zhihu.com/p/114341957 target=_blank rel=noopener>UE4移动的网络同步 - 知乎</a></li><li><a class=link href=https://zhuanlan.zhihu.com/p/664568047 target=_blank rel=noopener>UE4/UE5 Character Movement Component移动组件网络同步详解 - 知乎</a></li><li><a class=link href=https://zhuanlan.zhihu.com/p/650314172 target=_blank rel=noopener>「Grow by UE」图解角色移动组件 - 知乎</a></li><li><a class=link href=https://zhuanlan.zhihu.com/p/20098342802 target=_blank rel=noopener>UE移动同步原理分析（一）：Pawn的移动属性复制 - 知乎</a></li></ul></section><footer class=article-footer><section class=article-tags><a href=/tags/cpp/>C/C++</a>
<a href=/tags/unrealengine/>UnrealEngine</a></section><section class=article-copyright><svg class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span><p>该内容采用 CC BY-NC-SA 4.0 许可协议。</p><p>如果对您有帮助或存在意见建议，欢迎在下方评论交流。</p></span></section></footer><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css integrity=sha384-nB0miv6/jRmo5UMMR1wu3Gz6NLsoTkbqJghGIsx//Rlm+ZU03BU6SQNC66uf4l5+ crossorigin=anonymous><script src=https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.js integrity=sha384-7zkQWkzuo3B5mTepMUcHkMB5jZaolc2xDwL6VFqjFALcbeS9Ggm/Yr2r3Dy4lfFg crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/contrib/auto-render.min.js integrity=sha384-43gviWU0YVjaDtb/GhzOouOXtZMP/7XUzwPTstBeZFe/+rCMvRwr4yROQP43s0Xk crossorigin=anonymous defer></script><script>window.addEventListener("DOMContentLoaded",()=>{const e=document.querySelector(".main-article");renderMathInElement(e,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1},{left:"\\(",right:"\\)",display:!1},{left:"\\[",right:"\\]",display:!0}],ignoredClasses:["gist"]})})</script></article><aside class=related-content--wrapper><h2 class=section-title>相关文章</h2><div class=related-content><div class="flex article-list--tile"><article><a href=/knowledge/ue/ue-asan/><div class=article-details><h2 class=article-title>虚幻引擎中ASan相关机制</h2></div></a></article><article><a href=/knowledge/ue/network-role/><div class=article-details><h2 class=article-title>虚幻引擎中网络角色Role相关概念</h2></div></a></article><article><a href=/knowledge/ue/actor-replication/><div class=article-details><h2 class=article-title>虚幻引擎中Actor复制流程</h2></div></a></article><article><a href=/knowledge/ue/network-start/><div class=article-details><h2 class=article-title>虚幻引擎中网络相关机制</h2></div></a></article><article><a href=/knowledge/ue/editor-python/><div class=article-details><h2 class=article-title>虚幻引擎中编辑器下Python的使用</h2></div></a></article></div></div></aside><script src=https://giscus.app/client.js data-repo=BoilTask/BoilTask.github.io data-repo-id="MDEwOlJlcG9zaXRvcnkyODQ5Njk2MTU=" data-category=Announcements data-category-id=DIC_kwDOEPxKj84CkD1t data-mapping=pathname data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=top data-theme=light data-lang=en data-loading=lazy crossorigin=anonymous async></script><script>function setGiscusTheme(e){let t=document.querySelector("iframe.giscus-frame");t&&t.contentWindow.postMessage({giscus:{setConfig:{theme:e}}},"https://giscus.app")}(function(){addEventListener("message",t=>{if(event.origin!=="https://giscus.app")return;e()}),window.addEventListener("onColorSchemeChange",e);function e(){setGiscusTheme(document.documentElement.dataset.scheme==="light"?"light":"dark_dimmed")}})()</script><footer class=site-footer><section class=copyright>&copy;
2010 -
2025 BoilTask's Blog</section><section class=powerby><a href=https://beian.miit.gov.cn/ target=_blank rel=noopener>豫ICP备15024677号-1</a><br>使用 <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> 构建<br>主题 <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.30.0>Stack</a></b> 由 <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a> 设计<br>个性化 Stack-Boil 由 <a href=https://github.com/BoilTask target=_blank>BoilTask</a> 设计</section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.1e9a3bafd846ced4c345d084b355fb8c7bae75701c338f8a1f8a82c780137826.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script><script type=module>
  import mermaid from "https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.esm.min.mjs";

  mermaid.initialize({ startOnLoad: true });
</script><div id=loadingOverlay><div class=loader></div><p>加载中...</p></div><style>#loadingOverlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(255,255,255,.9);z-index:9999;display:none;justify-content:center;align-items:center;flex-direction:column}.loader{border:8px solid #f3f3f3;border-top:8px solid #3498db;border-radius:50%;width:60px;height:60px;animation:spin 1s linear infinite}@keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}</style></body></html>